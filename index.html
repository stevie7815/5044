<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <title>CS5044: Practical 2 </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="style.css" />

</head>

<body>
    <header>
        <h1>Which Social Movements & Protests had the largest impact on police shootings?</h1>
        <hr>
    </header>
    <main class="wrapper">
        <div>
            <a class="dataset" href="dataset.csv" target="_blank">Data Set</a>
        </div>
        <div id="lineGraph"> <h1>Police Shootings by Year</h1></div>
        <h1>Police Shootings by Race</h1>

        <svg width="800" height="400"></svg>

    </main>
    <footer>
        <p>Created by: sd302 & ifz1</p>
    </footer> 

</body>

</html>

<script>

// This is the start of the linegraph


// Load the data
d3.csv("dataset-linegraph.csv", function(d) {
    d.date = new Date(d.date);
    d.mentalIllness = +d.mentalIllness;
    d.withoutMentalIllness = +d.withoutMentalIllness;
    d.killed = +d.killed;
    return d;
}).then(function(data) {

const width = 900;
const height = 400;
const margin = { top: 20, right: 300, bottom: 35, left: 50 };
    
// Set the dimensions of the chart
const innerWidth = width - margin.left - margin.right;
const innerHeight = height - margin.top - margin.bottom;


// Create the SVG element
const svg = d3.select("#lineGraph").append("svg")
    .attr("width", width)
    .attr("height", height);

const rolledData = d3.rollup(data, (v) => d3.sum(v, (d) => d.killed),d => d.signs_of_mental_illness, (d) => d.date.getFullYear());
const countExtent = [0, d3.max(d3.hierarchy(rolledData).leaves().map(d => d.data[1]))];

// Define the scales
const timeExtent = d3.extent(data, (d) => d.date);
const xScale = d3.scaleTime()
    .range([0, innerWidth])
    .domain(timeExtent)

    
const yScale = d3.scaleLinear()
    .domain(countExtent)
    .range([innerHeight, 0]);

// Define the axes
const xAxis = d3.axisBottom(xScale)
    .tickFormat(d3.timeFormat("%Y"));

const yAxis = d3.axisLeft(yScale);

// Add the axes
    svg.append("g")
        .attr("transform", `translate(${margin.left}, ${innerHeight + margin.top})`)
        .call(xAxis);

    svg.append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`)
        .call(yAxis);

    // Add x-axis label
    svg.append("text")           
        .attr("transform", `translate(${width/2},${height - margin.top + 20})`)
        .style("text-anchor", "middle")
        .text("Year");

// Add y-axis label
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Number of Police Shootings");


let noMentalIllness = rolledData.get("FALSE");
let mentalIllness = rolledData.get("TRUE");

//Define the line functions
const line1 = d3.line()
    .x((d) => xScale(new Date(d[0], 0))) // Use the year as the x-value
    .y((d) => yScale(d[1])) // Use the sum as the y-value

const line2 = d3.line()
    .x((d) => xScale(new Date(d[0], 0)))
    .y((d) => yScale(d[1]))

// Add the line for shootings with mental illness signs
svg.append("path")
    .datum(mentalIllness)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("stroke-width", 1.5)
    .attr("d", line1) // Use the "d" attribute to specify the line function
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

// Add the line for shootings without mental illness signs
svg.append("path")
    .datum(noMentalIllness)
    .attr("fill", "none")
    .attr("stroke", "orange")
    .attr("stroke-width", 1.5)
    .attr("d", line2)
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

// Legend code adapted from https://d3-graph-gallery.com/graph/custom_legend.html
svg.append("circle")
    .attr("cx",550)
    .attr("cy",70)
    .attr("r", 7)
    .style("fill", "orange")

svg.append("circle")
    .attr("cx",550)
    .attr("cy",100)
    .attr("r", 7)
    .style("fill", "steelblue")

svg.append("text")
    .attr("x", 570)
    .attr("y", 100)
    .text("Shootings with mental illness signs")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")

svg.append("text")
    .attr("x", 570)
    .attr("y", 70)
    .text("Shootings without mental illness signs")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")


});
    
    //This is the end of the linegraph
    
    </script>
    
    </footer>

    
    <script>

        // set dimensions and margins
        var margin = {
            top: 20,
            right: 20,
            bottom: 30,
            left: 40
        };
        var width = 600 - margin.left - margin.right;
        var height = 400 - margin.top - margin.bottom;

        // create svg 
        var svg = d3.select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.left + margin.right)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // load data
        d3.csv("data/dataset.csv").then(function (data) {


            //////* SD302: POLICE SHOOTINGS Mental health *///////


            //////* SD302: POLICE SHOOTINGS BY RACE *///////

            // process data
            const raceCounts = d3.rollup(data, v => v.length, d => d.race);
            const raceData = Array.from(raceCounts, d => ({ race: d[0], count: d[1] }));
            raceData.sort((a, b) => d3.descending(a.count, b.count));


            // x y scales
            const x = d3.scaleBand()
                .domain(raceData.map(d => d.race))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(raceData, d => d.count)])
                .range([height, 0])


            // create x axis
            const xAxis = d3.axisBottom(x);

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            /* code adapted from http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html */
            svg.append("text")  // x axis label
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - -10)
                .style("text-anchor", "middle")
                .text("Race");
            /* end of adapted code */

            // create y axis
            const yAxis = d3.axisLeft(y);

            svg.append("g")
                .call(yAxis);

            /* code adapted from http://www.d3noob.org/2012/12/adding-axis-labels-to-d3js-graph.html */
            svg.append("text")  // x axis label
                .attr("x", -height / 2)
                .attr("y", -margin.left + 10)
                .attr("transform", "rotate(-90)")
                .style("text-anchor", "middle")
                .text("Number of Shootings");
            /* end of adapted code */

            // add colour
            const colour = d3.scaleOrdinal()
                .domain(raceData.map(d => d.race))
                .range(d3.schemeSet2);

            // create bars
            svg.selectAll(".bar")
                .data(raceData)
                .enter().append("rect")
                .attr("x", d => x(d.race))
                .attr("y", d => y(d.count)) // position bar from bottom
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.count)) // height relative to the bottom
                .attr("fill", d => colour(d.race)); // add colour to bars

        }).catch(function (error) {
            console.log(error);
        });

        /*
        /*  attempt at barchart - data not printing *
                // set dimensions and margins
                var margin = {
                    top: 20,
                    right: 30,
                    bottom: 50,
                    left: 50
                };
                var width = 600 - margin.left - margin.right;
                var height = 400 - margin.top - margin.bottom;
        
        
                var svg = d3.select("#chart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");
        
                // load data
                d3.csv("data/dataset.csv", function (data) {
                    console.log("first data " + data);
        
                    //change age strings to numeric values
                    data.forEach(d => d.age = +d.age);
        
                    console.log("for each" + data);
        
                    // group data by age
                    var groupedData = d3.nest()
                        .key(function (d) {
                            if (d.age < 18) {
                                return "<18";
                            }
                            else if (d.age < 25) {
                                return "18-24";
                            }
                            else if (d.age < 35) {
                                return "25-34";
                            }
                            else if (d.age < 45) {
                                return "35-44";
                            }
                            else if (d.age < 55) {
                                return "45-54";
                            }
                            else {
                                return "55+";
                            }
                        })
                        .rollup(function (v) { return v.length; })
                        .entries(data);
        
                    // create x and y scale
                    var x = d3.scaleBand()
                        .range([0, width])
                        .padding(0.1);
        
                    var y = d3.scaleLinear()
                        .range([height, 0]);
        
                    // set scale domains
                    x.domain(groupedData.map(function (d) { return d.key; }));
                    y.domain([0, d3.max(groupedData, function (d) { return d.value; })]);
        
                    // add x-axis
                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));
        
                    // add y axis
                    svg.append("g")
                        .attr("class", "y axis")
                        .call(d3.axisLeft(y));
        
                    // add bars
                    svg.selectAll(".bar")
                        .data(groupedData)
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", function (d) { return x(d.key); })
                })
        */

    </script>
</body>

</html>